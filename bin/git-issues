#!/usr/bin/env ruby

require 'thor'
require 'zlog'
require 'git-issues'

class GitIssuesCLI < Thor
  Log = Logging.logger[self]
  GI = GitIssues.new

  desc "list", "list issues of a repository"
  method_options :all => :boolean
  def list opts = {}
    o = ({
      all: (options.all)
    }).merge(opts)

    issues = repo.issues_list o
    issues.each do |i|
      puts "%-3i | %-8s | %s" % [ i['local_id'], i['status'], i['title'] ]
    end
    nil
  end

  desc "add <title> <content>", "add a new issue"
  def add( title, content )
    repo.issue_create title, content
  end

  desc "delete <id>", "delete an issue"
  def delete( id )
    repo.issue_delete id
  end

  desc "cli", "open a cli"
  def cli
    require 'pry'
    binding.pry
  end

  private

  def repo path = '.'
    @repo ||= getRepo path
  end

  def getRepo path
    repos = GI.gitReposFor '.'
    if repos.empty?
      Log.abort "No known repositories found."
    end
    Log.info "Using: #{repos.first.repo_url}"
    repos.first
  end

end

GitIssuesCLI.start(ARGV)
